package config

import (
	"chanchai/entity"
	"fmt"
	"log"
	"os"

	"gorm.io/driver/sqlite"
	"gorm.io/gorm"
)

var db *gorm.DB

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
func DB() *gorm.DB {
	return db
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
func ConnectDB() {
	var err error

	// ‡∏≠‡πà‡∏≤‡∏ô DB_NAME ‡∏à‡∏≤‡∏Å environment variable
	dbName := os.Getenv("DB_NAME")
	if dbName == "" {
		dbName = "GOTNAJA.db" // default
	}

	database, err := gorm.Open(sqlite.Open(dbName+"?cache=shared"), &gorm.Config{})
	if err != nil {
		log.Fatal("‚ùå Failed to connect database:", err)
	}

	fmt.Printf("‚úÖ Connected to database: %s\n", dbName)
	db = database
}


// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
func SetupDatabase() {
	if db == nil {
		log.Fatal("‚ùå Database connection is nil. Please call ConnectDB() first.")
	}

	err := db.AutoMigrate(
		&entity.User{},
		&entity.Role{},
	)

	if err != nil {
		log.Fatal("‚ùå Failed to migrate database:", err)
	}

	fmt.Println("‚úÖ Database migrated successfully!")

	SeedDatabase()

}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Test Mode (‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• mockup)
func SetupDatabaseTestMode() {
	if db == nil {
		log.Fatal("‚ùå Database connection is nil. Please call ConnectDB() first.")
	}

	err := db.AutoMigrate(
		&entity.User{},
		&entity.Role{},
	)

	if err != nil {
		log.Fatal("‚ùå Failed to migrate database:", err)
	}

	fmt.Println("‚úÖ Database migrated successfully! (Test Mode - No mockup data)")
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á
func SeedDatabase() {

	// üîπ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Role
	roles := []entity.Role{
		{Name: "Guest"},
		{Name: "Admin"},
	}
	for _, role := range roles {
		db.FirstOrCreate(&role, entity.Role{Name: role.Name})
	}

	// üîπ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Users
	users := []entity.User{
		{

			FirstName: "Admin",
			LastName:  "Admin",
			Email:     "admin@gmail.com",
			Password:  "123456",
			RoleID:    2,
		},
		{
			FirstName: "Guest",
			LastName:  "1",
			Email:     "Guest@gmail.com",
			Password:  "123456",
			RoleID:    1, // Manager (ID 4)

		},
	}
	for i, user := range users {
		users[i].Password, _ = HashPassword(user.Password)
		db.FirstOrCreate(&users[i], entity.User{Email: user.Email})
	}

}
